# 1. ‡πÉ‡∏ä‡πâ official Rust image ‡πÄ‡∏õ‡πá‡∏ô base image
FROM rust:latest AS builder

# 2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á wasm32 target ‡πÅ‡∏•‡∏∞ trunk
RUN rustup target add wasm32-unknown-unknown
RUN cargo install trunk wasm-bindgen-cli

# 3. ‡∏ï‡∏±‡πâ‡∏á working directory
WORKDIR /app

# 4. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå manifest ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ build ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
COPY Cargo.toml Cargo.lock ./

# 5. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå index.html ‡πÅ‡∏•‡∏∞ source code
COPY index.html ./
COPY src ./src

# 6. ‡∏ï‡∏±‡πâ‡∏á ENV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ trunk ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏≠‡∏ô compile
ARG BACKEND_URL
ENV BACKEND_URL=${BACKEND_URL}

RUN echo "üîß BACKEND_URL = $BACKEND_URL" \
    && trunk build --release --public-url /

# 7. ‡πÉ‡∏ä‡πâ nginx serve ‡πÑ‡∏ü‡∏•‡πå frontend
FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
